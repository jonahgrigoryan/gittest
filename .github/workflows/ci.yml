name: CI

on:
  push:
    branches:
      - main
      - feat/**
      - m3/**
      - agent-zero/**
      - agent-zero-codebase-review
    tags:
      - v*
  pull_request:
    branches:
      - main
      - agent-zero-codebase-review
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v3
        with:
          version: 9
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20.17.0
          cache: "pnpm"

      - run: pnpm -v
      - run: pnpm install --frozen-lockfile
      - run: pnpm run verify:env

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11.9"
      - run: python -m pip install --upgrade pip poetry
      - run: python -V

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.85.0
        with:
          components: rustfmt, clippy

      - run: pnpm run ci:verify

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            results/session
            results/hands
            results/replay
            results/verification.json

  docker:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry
        if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.CONTAINER_REGISTRY || 'ghcr.io' }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_TOKEN }}

      - name: Sanitize branch name for Docker tag
        id: sanitize
        run: |
          SANITIZED_REF=$(echo "${{ github.ref_name }}" | tr '/' '-')
          echo "sanitized_ref=$SANITIZED_REF" >> $GITHUB_OUTPUT

      - name: Build orchestrator image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: infra/docker/workspace.Dockerfile
          build-args: |
            WORKSPACE=@poker-bot/orchestrator
            START_COMMAND=node dist/main.js
            GIT_SHA=${{ github.sha }}
            BUILD_TS=${{ github.event.head_commit.timestamp || github.run_started_at }}
            PNPM_VERSION=9.0.0
          tags: |
            ${{ vars.CONTAINER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}-orchestrator:sha-${{ github.sha }}
            ${{ vars.CONTAINER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}-orchestrator:${{ steps.sanitize.outputs.sanitized_ref }}
          push: ${{ startsWith(github.ref, 'refs/tags/v') }}

      - name: Build solver image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/solver/Dockerfile
          tags: |
            ${{ vars.CONTAINER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}-solver:sha-${{ github.sha }}
            ${{ vars.CONTAINER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}-solver:${{ steps.sanitize.outputs.sanitized_ref }}
          push: ${{ startsWith(github.ref, 'refs/tags/v') }}

      - name: Build vision image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/vision/Dockerfile
          tags: |
            ${{ vars.CONTAINER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}-vision:sha-${{ github.sha }}
            ${{ vars.CONTAINER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}-vision:${{ steps.sanitize.outputs.sanitized_ref }}
          push: ${{ startsWith(github.ref, 'refs/tags/v') }}

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 9
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20.17.0
          cache: "pnpm"

      - run: pnpm install --frozen-lockfile

      - name: pnpm audit
        run: pnpm audit --prod

      - name: Prepare SBOM directory
        run: mkdir -p sbom

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.85.0

      - name: Install cargo-audit (compatible with toolchain)
        run: cargo install --locked cargo-audit@0.22.0

      - name: cargo audit (solver)
        working-directory: services/solver
        run: cargo audit

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pip-audit tooling
        run: |
          python -m pip install --upgrade pip pip-audit poetry poetry-plugin-export

      - name: pip-audit (vision)
        working-directory: services/vision
        run: |
          poetry export -f requirements.txt --without-hashes -o requirements-audit.txt
          pip-audit -r requirements-audit.txt

      - name: Secrets scan (gitleaks)
        run: |
          set -euo pipefail
          GITLEAKS_VERSION="8.18.4"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz gitleaks
          ./gitleaks detect --no-banner --redact

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          format: table
          exit-code: 1

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          output-file: sbom/sbom.spdx.json
          format: spdx-json

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign SBOM
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          if [ -n "${COSIGN_PRIVATE_KEY}" ]; then
            cosign sign-blob \
              --yes \
              --key env://COSIGN_PRIVATE_KEY \
              --output-signature sbom/sbom.spdx.json.sig \
              sbom/sbom.spdx.json
          else
            echo "COSIGN_PRIVATE_KEY not set; skipping SBOM signing."
          fi

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom

  smoke_compose:
    needs: [docker]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create CI env file
        run: cp .env.example .env.ci

      - name: Bring up stack
        run: |
          cd infra/compose
          docker compose --env-file ../../.env.ci up --build orchestrator -d

      - name: Wait for orchestrator healthy
        run: |
          cd infra/compose
          timeout 180 bash -c 'until docker compose --env-file ../../.env.ci ps orchestrator | grep "healthy"; do sleep 5; done'

      - name: Tear down stack
        if: always()
        run: |
          cd infra/compose
          docker compose --env-file ../../.env.ci down -v

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build, security, docker, smoke_compose]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download SBOM artifact
        uses: actions/download-artifact@v4
        with:
          name: sbom
          path: sbom

      - name: Ensure SBOM signature placeholder
        run: |
          if [ ! -f sbom/sbom.spdx.json.sig ]; then
            echo "Cosign signature not generated for this release." > sbom/sbom.spdx.json.sig
          fi

      - name: Generate changelog
        run: |
          git log -1 --pretty=medium > release-notes.txt

      - name: Upload release artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            sbom/sbom.spdx.json
            sbom/sbom.spdx.json.sig
            release-notes.txt
          body_path: release-notes.txt

      - name: Notify observability
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
        env:
          RELEASE_WEBHOOK_URL: ${{ secrets.RELEASE_WEBHOOK_URL }}
        run: |
          if [ -n "${RELEASE_WEBHOOK_URL}" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d '{"event":"release","tag":"${GITHUB_REF_NAME}","commit":"${GITHUB_SHA}"}' \
              "${RELEASE_WEBHOOK_URL}"
          else
            echo "RELEASE_WEBHOOK_URL not set; skipping observability notify."
          fi
